================================================================================
           범용 오케스트레이션 시스템 - 흐름도 (시각화)
================================================================================

┌────────────────────────────────────────────────────────────────────────────┐
│                           USER INTERACTION                                 │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  사용자: "공장 장비 상태를 알려줘"                                          │
│                                                                             │
└────────┬─────────────────────────────────────────────────────────────────────┘
         │
         │ Natural Language Input
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                        OPS ROUTER / DISPATCHER                             │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  질의 분석 → "공장/장비" 관련 → Generic Domain 선택                         │
│                                                                             │
│  ┌─ CI Domain Planner     (특화된 CI 질의 처리)                           │
│  ├─ Generic Planner ◄──── (공장, 제조 등 일반 질의) ← 현재               │
│  └─ Custom Planner        (기타 도메인)                                    │
│                                                                             │
└────────┬─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                      GENERIC PLANNER (도메인 선택)                          │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  질의: "공장 장비 상태를 알려줘"                                            │
│                                                                             │
└────────┬─────────────────────────────────────────────────────────────────────┘
         │
         │ 적합한 Tool 찾기 필요
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                    LLM TOOL SELECTOR (핵심 - LLM 사용!)                     │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Step 1: Tool Registry 조회                                               │
│  ┌─────────────────────────────────────────────────────────┐               │
│  │ 등록된 Tool 목록:                                        │               │
│  │                                                          │               │
│  │ 1. equipment_search                                      │               │
│  │    Desc: "공장 장비 검색. 키: 장비, 설비, equipment"    │               │
│  │                                                          │               │
│  │ 2. maintenance_history                                   │               │
│  │    Desc: "유지보수 이력. 키: 정비, 점검, 유지"          │               │
│  │                                                          │               │
│  │ 3. production_status                                     │               │
│  │    Desc: "생산 현황. 키: 생산, 제조, 현황"              │               │
│  │                                                          │               │
│  │ 4. bom_lookup                                            │               │
│  │    Desc: "BOM 조회. 키: 부품, BOM, 구성"               │               │
│  │                                                          │               │
│  │ 5. worker_schedule                                       │               │
│  │    Desc: "근무 일정. 키: 근무, 스케줄, 일정"            │               │
│  │                                                          │               │
│  │ 6. energy_consumption                                    │               │
│  │    Desc: "에너지 소비. 키: 전력, 에너지, 소비"          │               │
│  └─────────────────────────────────────────────────────────┘               │
│                                                                             │
│  Step 2: LLM에 질의 + Tool 목록 제공                                       │
│  ┌─────────────────────────────────────────────────────────┐               │
│  │ LLM Prompt:                                              │               │
│  │ "질문: 공장 장비 상태를 알려줘"                          │               │
│  │ "위 도구 중 가장 적합한 것을 선택하세요"                │               │
│  │ "신뢰도와 선택 이유도 함께"                             │               │
│  └─────────────────────────────────────────────────────────┘               │
│                                                                             │
│  Step 3: LLM 분석                                                          │
│  ┌─────────────────────────────────────────────────────────┐               │
│  │ LLM: "description을 읽으니:                               │               │
│  │      - equipment_search가 '장비' 키워드 포함 ✓          │               │
│  │      - description에 '설비, equipment' 있음 ✓           │               │
│  │      - 신뢰도: 0.95 (매우 높음)"                        │               │
│  │                                                          │               │
│  │      "production_status도 관련:                          │               │
│  │      - '생산', '현황' 포함                              │               │
│  │      - 신뢰도: 0.82 (높음)"                             │               │
│  │                                                          │               │
│  │      "나머지는 낮은 신뢰도"                              │               │
│  └─────────────────────────────────────────────────────────┘               │
│                                                                             │
│  Step 4: 결과 생성                                                         │
│  ┌─────────────────────────────────────────────────────────┐               │
│  │ {                                                        │               │
│  │   "tools": [                                             │               │
│  │     {                                                    │               │
│  │       "tool_name": "equipment_search",                   │               │
│  │       "confidence": 0.95,                                │               │
│  │       "reasoning": "공장 장비와 직접 관련",              │               │
│  │       "parameters": {"keyword": "상태"}                  │               │
│  │     },                                                   │               │
│  │     {                                                    │               │
│  │       "tool_name": "production_status",                  │               │
│  │       "confidence": 0.82,                                │               │
│  │       "reasoning": "생산 현황도 장비 상태 파악에 도움",   │               │
│  │       "parameters": {}                                   │               │
│  │     }                                                    │               │
│  │   ],                                                     │               │
│  │   "execution_order": "parallel"                          │               │
│  │ }                                                        │               │
│  └─────────────────────────────────────────────────────────┘               │
│                                                                             │
└────────┬─────────────────────────────────────────────────────────────────────┘
         │ GenericPlan 생성
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                     TOOL CHAIN EXECUTOR (병렬 실행)                         │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  execution_order: "parallel" → 두 Task 동시 실행                          │
│                                                                             │
│  ┌───────────────────────────────┐  ┌──────────────────────────────┐       │
│  │  TASK 1: equipment_search     │  │  TASK 2: production_status   │       │
│  │                               │  │                              │       │
│  │ 1. Config 로드                │  │ 1. Config 로드               │       │
│  │    {                          │  │    {                         │       │
│  │      source_ref:             │  │      source_ref:             │       │
│  │      "primary_postgres",     │  │      "primary_postgres",     │       │
│  │      query_template: "..."    │  │      query_template: "..."   │       │
│  │    }                          │  │    }                         │       │
│  │                               │  │                              │       │
│  │ 2. Source Asset 로드 ◄────────┤──┤──► Source Asset 로드         │       │
│  │    "primary_postgres"         │  │    "primary_postgres"        │       │
│  │    {                          │  │    {                         │       │
│  │      host: 115.21.12.151      │  │      host: 115.21.12.151     │       │
│  │      port: 5432              │  │      port: 5432             │       │
│  │      database: spadb          │  │      database: spadb         │       │
│  │      user: spa                │  │      user: spa               │       │
│  │      password: ***            │  │      password: ***           │       │
│  │    }                          │  │    }                         │       │
│  │                               │  │                              │       │
│  │ 3. DB 연결                    │  │ 3. DB 연결                   │       │
│  │    conn = DB 접속             │  │    conn = DB 접속            │       │
│  │                               │  │                              │       │
│  │ 4. Query 실행                 │  │ 4. Query 실행                │       │
│  │    SQL: SELECT * FROM         │  │    SQL: SELECT * FROM        │       │
│  │    equipment WHERE            │  │    production_order WHERE    │       │
│  │    name ILIKE '%상태%'        │  │    status='running'          │       │
│  │    LIMIT 10                   │  │    LIMIT 10                  │       │
│  │                               │  │                              │       │
│  │ 5. 결과 수신 ✓                │  │ 5. 결과 수신 ✓               │       │
│  │    [                          │  │    [                         │       │
│  │      {                        │  │      {                       │       │
│  │        id: 1,                 │  │        order_id: "ORD-123",   │       │
│  │        name: "장비-001",       │  │        status: "진행중",       │       │
│  │        status: "정상"         │  │        progress: "70%"       │       │
│  │      },                       │  │      },                      │       │
│  │      {                        │  │      {                       │       │
│  │        id: 2,                 │  │        order_id: "ORD-124",   │       │
│  │        name: "장비-002",       │  │        status: "진행중"       │       │
│  │        status: "정상"         │  │      },                      │       │
│  │      },                       │  │      ...                     │       │
│  │      ... (12개 총)            │  │    ]                         │       │
│  │    ]                          │  │                              │       │
│  └───────────────────────────────┘  └──────────────────────────────┘       │
│                                                                             │
│  ⏳ 모든 Task 완료 대기 (병렬이므로 가장 오래 걸린 Task 기준)               │
│                                                                             │
│  ✓ 완료! 결과 통합:                                                        │
│    {                                                                        │
│      equipment_search: [...12개 장비 데이터...],                            │
│      production_status: [...3개 주문 데이터...]                             │
│    }                                                                        │
│                                                                             │
└────────┬─────────────────────────────────────────────────────────────────────┘
         │ Tool 실행 완료, 데이터 통합
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                    RESPONSE GENERATION (답변 생성)                          │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ LLM이 통합 데이터로 자연스러운 답변 생성:                                   │
│                                                                             │
│ "공장의 장비 상태:                                                          │
│  • 총 12개 장비 운영 중                                                    │
│  • 모두 정상 상태                                                          │
│  • 각 장비: 장비-001, 장비-002, ... (모두 정상)                            │
│                                                                             │
│  생산 현황:                                                                 │
│  • 진행 중인 주문: 3개                                                     │
│  • ORD-123: 70% 진행 중                                                   │
│  • ORD-124: 30% 진행 중                                                   │
│  • ORD-125: 준비 중                                                        │
│                                                                             │
│  종합: 모든 장비가 정상이며, 생산도 일정대로 진행 중입니다."              │
│                                                                             │
└────────┬─────────────────────────────────────────────────────────────────────┘
         │ 답변 생성 완료
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                           USER RESPONSE                                    │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 사용자에게 자연스러운 답변 반환 ✓                                           │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘


================================================================================
                          KEY POINT: LLM Tool Selector
================================================================================

LLM이 무엇을 기반으로 Tool을 선택하는가?

1️⃣  Tool Description 읽음
    "공장 장비 검색. 키워드: 장비, 설비, equipment, machine"
                    ↓
2️⃣  사용자 질의와 비교
    "공장 장비 상태" ↔ "장비 검색"
                    ↓
3️⃣  유사성 판단
    "장비" 키워드가 일치 → 신뢰도 높음 (0.95)
                    ↓
4️⃣  Tool 선택 & 파라미터 추출
    Tool: equipment_search
    Parameter: {keyword: "상태"}


================================================================================
                       각 Asset의 관계와 필수 여부
================================================================================

┌─────────────┐
│ Tool Asset  │  (필수) LLM이 선택할 대상
│ - name      │  - description (LLM이 읽음)
│ - tool_type │  - input_schema (파라미터 추출)
│ - config    │  - source_ref (데이터소스 참조)
└──────┬──────┘
       │
       │ source_ref: "primary_postgres"
       │ (Tool이 이것을 사용)
       ▼
┌──────────────────┐
│  Source Asset    │  (필수) DB/API 연결 정보
│  - name          │  - host, port, database
│  - connection    │  - user, password
└──────────────────┘

추가 Asset (선택):
┌──────────────┐
│ Query Asset  │  복잡한 SQL을 미리 저장
└──────────────┘

┌──────────────┐
│ Mapping      │  키워드 매핑 (LLM 없을 때)
│ Asset        │
└──────────────┘


================================================================================
                              최종 결론
================================================================================

Tool Asset + Source Asset = 완전한 오케스트레이션!

✓ Tool Asset: LLM이 선택할 도구들 정의
✓ Source Asset: 데이터를 가져올 DB/API 연결 정보
✓ 다른 Asset: 특정 도메인이나 고급 기능용 (선택사항)

동작 방식:
  질의 → LLM이 Tool 선택 → Tool이 Source를 통해 데이터 조회 → 답변 생성

