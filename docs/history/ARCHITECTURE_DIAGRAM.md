# LLM-Based Tool Selection & Parallel Execution - Visual Architecture

## 1. Data Flow Diagram (Current vs Target)

### Current Architecture (Before)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Query     â”‚
â”‚ "CPU ì‚¬ìš©ëŸ‰ì„    â”‚
â”‚  ë³´ì—¬ì¤˜"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Planner LLM                        â”‚
â”‚  Input:                                 â”‚
â”‚  - User Query                           â”‚
â”‚  - Mappings (keyword mapping)           â”‚
â”‚  âŒ NO Tool Info                        â”‚
â”‚  âŒ NO Catalog Info                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Plan Output                            â”‚
â”‚  {                                      â”‚
â”‚    intent: "QueryMetrics",              â”‚
â”‚    primary: {keywords, filters, limit}  â”‚
â”‚    metric: {metric_name, agg, ...}      â”‚
â”‚    âŒ NO tool_type field                â”‚
â”‚  }                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Stage Executor                     â”‚
â”‚  Execute Stage                          â”‚
â”‚  âŒ HARDCODED tool_type="ci_lookup"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sequential Tool Execution              â”‚
â”‚  Primary Query (ci_lookup)  [100ms]     â”‚
â”‚        â†“ wait...                        â”‚
â”‚  Metric Query (metric)      [100ms]     â”‚
â”‚        â†“ wait...                        â”‚
â”‚  TOTAL: ~200ms              âŒ SLOW     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Problems**:
- âŒ Tool selection is hardcoded
- âŒ LLM doesn't see available tools
- âŒ LLM doesn't know database structure
- âŒ Sequential execution wastes time

---

### Target Architecture (After)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Query     â”‚
â”‚ "CPU ì‚¬ìš©ëŸ‰ì„    â”‚
â”‚  ë³´ì—¬ì¤˜"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load Context Information               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Tool Registry Info:                 â”‚
â”‚     - ci_lookup (keywords, filters)     â”‚
â”‚     - metric_query (metric, agg)        â”‚
â”‚     - graph_analysis (scope, view)      â”‚
â”‚                                         â”‚
â”‚  2. Catalog Info:                       â”‚
â”‚     - servers table:                    â”‚
â”‚       * server_id (VARCHAR)             â”‚
â”‚       * environment (VARCHAR)           â”‚
â”‚       * status (VARCHAR)                â”‚
â”‚     - metrics table:                    â”‚
â”‚       * metric_name                     â”‚
â”‚       * value (NUMERIC)                 â”‚
â”‚       * timestamp                       â”‚
â”‚                                         â”‚
â”‚  3. Mappings                            â”‚
â”‚     - keyword â†’ metric mapping          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Planner LLM                        â”‚
â”‚  Input:                                 â”‚
â”‚  - User Query                           â”‚
â”‚  - âœ… Available Tools Info              â”‚
â”‚  - âœ… Tool Input Schemas                â”‚
â”‚  - âœ… Database Catalog Info             â”‚
â”‚  - Mappings                             â”‚
â”‚                                         â”‚
â”‚  LLM decides:                           â”‚
â”‚  1. Which tools to use                  â”‚
â”‚  2. What parameters for each tool       â”‚
â”‚  3. What filters to apply               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Enhanced Plan Output                   â”‚
â”‚  {                                      â”‚
â”‚    intent: "QueryMetrics",              â”‚
â”‚    primary: {                           â”‚
â”‚      keywords: ["server", "prod"],      â”‚
â”‚      filters: {environment: "prod"},    â”‚
â”‚      limit: 10,                         â”‚
â”‚      tool_type: "ci_lookup"  âœ… LLM     â”‚
â”‚    },                                   â”‚
â”‚    metric: {                            â”‚
â”‚      metric_name: "cpu_usage",          â”‚
â”‚      agg: "avg",                        â”‚
â”‚      time_range: {...},                 â”‚
â”‚      tool_type: "metric_query" âœ… LLM   â”‚
â”‚    }                                    â”‚
â”‚  }                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Stage Executor                     â”‚
â”‚  Extract tool_type from Plan            â”‚
â”‚  âœ… Dynamic based on LLM decision       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Parallel Tool Execution                â”‚
â”‚  (asyncio.gather)                       â”‚
â”‚                                         â”‚
â”‚  Task 1: Primary Query (ci_lookup)      â”‚
â”‚  Task 2: Metric Query (metric_query)    â”‚
â”‚           â†“â†“ Execute simultaneously â†“â†“  â”‚
â”‚  TOTAL: ~100ms                âœ… FAST   â”‚
â”‚  (50% faster than sequential)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Results                                â”‚
â”‚  {                                      â”‚
â”‚    primary_results: {...},              â”‚
â”‚    metric_results: {...}                â”‚
â”‚  }                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Benefits**:
- âœ… Tool selection is dynamic (based on LLM)
- âœ… LLM sees all available tools and can choose best one
- âœ… LLM understands database structure for better filtering
- âœ… Parallel execution is 2x faster for 2 tools

---

## 2. Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User Input                             â”‚
â”‚                  "CPU ì‚¬ìš©ëŸ‰ì„ ë³´ì—¬ì¤˜"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Orchestrator            â”‚
        â”‚  - Coordinates flow      â”‚
        â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
          â”‚            â”‚       â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”‚
    â”‚Planner â”‚  â”‚Executor   â”‚  â”‚
    â”‚        â”‚  â”‚Stage      â”‚  â”‚
    â””â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
      â”‚                â”‚        â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
      â”‚        â”‚                â”‚
      â–¼        â–¼                â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  Planner LLM            â”‚  â”‚
   â”‚                         â”‚  â”‚
   â”‚  Uses Context:          â”‚  â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚
          â”‚          â”‚   â”‚      â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â” â”Œâ–¼â”€â”€â”   â”‚
    â”‚Tools Infoâ”‚ â”‚Catâ”‚â”‚Mapâ”‚   â”‚
    â”‚Registry  â”‚ â”‚logâ”‚â”‚   â”‚   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”˜ â””â”€â”€â”€â”˜   â”‚
                   â”‚           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                       â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚ Plan Schema           â”‚   â”‚
   â”‚ {                     â”‚   â”‚
   â”‚   intent              â”‚   â”‚
   â”‚   primary {           â”‚   â”‚
   â”‚     keywords          â”‚   â”‚
   â”‚     filters           â”‚   â”‚
   â”‚     tool_type â† NEW   â”‚   â”‚
   â”‚   }                   â”‚   â”‚
   â”‚   metric {            â”‚   â”‚
   â”‚     metric_name       â”‚   â”‚
   â”‚     tool_type â† NEW   â”‚   â”‚
   â”‚   }                   â”‚   â”‚
   â”‚ }                     â”‚   â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â”‚                    â”‚
          â–¼                    â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
   â”‚ Stage Executor   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ _execute_execute â”‚
   â”‚                  â”‚
   â”‚ 1. Read tool_type
   â”‚    from Plan
   â”‚ 2. Create tasks
   â”‚ 3. asyncio.gather
   â”‚    (parallel)
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Tool Registry        â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚ ci_lookup       â”‚  â”‚
   â”‚  â”‚ metric_query    â”‚  â”‚
   â”‚  â”‚ graph_analysis  â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”˜
          â”‚        â”‚   â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â” â”Œâ”€â”€â”€â”€â–¼â” â”Œâ–¼â”€â”€â”€â”€â”
    â”‚Tool1 â”‚ â”‚Tool2â”‚ â”‚Tool3â”‚
    â”‚Exec  â”‚ â”‚Exec â”‚ â”‚Exec â”‚
    â”‚      â”‚ â”‚     â”‚ â”‚     â”‚
    â”‚ ||â”€â”€â”€â”¼â”€â”¼â”€â”€|| â”‚ â”‚
    â”‚(wait)  (wait)  (wait)
    â”‚ â–¼â–¼â–¼â–¼  Parallelâ–¼â–¼â–¼â–¼
    â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”˜
                       â”‚
                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Compose Resultsâ”‚
                  â”‚ Return to User â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Tool Selection Decision Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Query Input               â”‚
â”‚  "prod ì„œë²„ CPU í˜„í™© ë³´ì—¬ì¤˜"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Analyze Query                   â”‚
â”‚  - Keywords: server, prod, cpu   â”‚
â”‚  - Intent: Metrics Query         â”‚
â”‚  - Time Frame: current/recent    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Available Tools                 â”‚
â”‚  1. ci_lookup                    â”‚
â”‚     Purpose: Find infrastructure â”‚
â”‚     Takes: keywords, filters     â”‚
â”‚                                  â”‚
â”‚  2. metric_query                 â”‚
â”‚     Purpose: Get metrics         â”‚
â”‚     Takes: metric_name, agg      â”‚
â”‚                                  â”‚
â”‚  3. graph_analysis               â”‚
â”‚     Purpose: Visualize relations â”‚
â”‚     Takes: scope, view           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database Catalog                â”‚
â”‚  servers table:                  â”‚
â”‚    - server_id                   â”‚
â”‚    - environment (prod/dev)      â”‚
â”‚    - status                      â”‚
â”‚                                  â”‚
â”‚  metrics table:                  â”‚
â”‚    - metric_name (cpu, mem...)   â”‚
â”‚    - value                       â”‚
â”‚    - timestamp                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM Decision                    â”‚
â”‚  "I need to:"                    â”‚
â”‚  1. Find servers with prod tag   â”‚
â”‚     â†’ Use: ci_lookup             â”‚
â”‚       tool_type = "ci_lookup"    â”‚
â”‚                                  â”‚
â”‚  2. Get CPU metrics for servers  â”‚
â”‚     â†’ Use: metric_query          â”‚
â”‚       tool_type = "metric_query" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Plan with Tool Selections       â”‚
â”‚  {                               â”‚
â”‚    "primary": {                  â”‚
â”‚      "keywords": [...],          â”‚
â”‚      "filters": {                â”‚
â”‚        "environment": "prod"     â”‚
â”‚      },                          â”‚
â”‚      "tool_type":                â”‚
â”‚        "ci_lookup" â† Selected!   â”‚
â”‚    },                            â”‚
â”‚    "metric": {                   â”‚
â”‚      "metric_name": "cpu_usage", â”‚
â”‚      "agg": "avg",               â”‚
â”‚      "tool_type":                â”‚
â”‚        "metric_query" â† Selected!â”‚
â”‚    }                             â”‚
â”‚  }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Parallel Execution Timeline

### Before (Sequential)
```
Timeline (ms)
0          50         100        150        200
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚ Primary Query  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—             â”‚
â”‚ (ci_lookup)    â•‘   WAITING     â•‘[100ms]      â”‚
â”‚                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•             â”‚
â”‚                                 â•”â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚ Metric Query   â•‘ WAITING       â•‘[100ms]   â”‚
â”‚ (metric_query) â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                            â”‚
â”‚ Total Time: ~200ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After (Parallel)
```
Timeline (ms)
0          50         100        150
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚ Primary Query  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—     â”‚
â”‚ (ci_lookup)    â•‘   RUN       â•‘    â”‚
â”‚                â•‘ [100ms]     â•‘    â”‚
â”‚                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                    â”‚
â”‚ Metric Query   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚ (metric_query) â•‘   RUN       â•‘    â”‚
â”‚                â•‘ [100ms]     â•‘    â”‚
â”‚                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                    â”‚
â”‚ ğŸš€ Both running simultaneously!    â”‚
â”‚                                    â”‚
â”‚ Total Time: ~100ms (50% faster!)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Code Implementation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  apps/api/main.py - Startup                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ initialize_tools()                             â”‚ â”‚
â”‚  â”‚ initialize_mappings()                          â”‚ â”‚
â”‚  â”‚ initialize_catalogs() â† NEW (load from DB)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tool Registryâ”‚ â”‚ Mapping    â”‚ â”‚ Asset Registry
â”‚              â”‚ â”‚ Registry   â”‚ â”‚ (Catalog)
â”‚- ci_lookup   â”‚ â”‚            â”‚ â”‚
â”‚- metric_queryâ”‚ â”‚- metric_   â”‚ â”‚- SchemaCatalog
â”‚- graph_      â”‚ â”‚  aliases   â”‚ â”‚- Tables
â”‚  analysis    â”‚ â”‚- agg_      â”‚ â”‚- Columns
â”‚              â”‚ â”‚  keywords  â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â†“              â†“              â†“
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Planner receives:            â”‚
        â”‚ - User Query                 â”‚
        â”‚ - tools_info (from registry) â”‚
        â”‚ - mappings (from registry)   â”‚
        â”‚ - catalog (from asset reg.)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ build_planner_prompt()       â”‚
        â”‚ Formats everything into      â”‚
        â”‚ a comprehensive prompt       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ LLM Generation               â”‚
        â”‚ (claude-3.5-sonnet)          â”‚
        â”‚ Returns Plan JSON with       â”‚
        â”‚ tool_type selections         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Plan Validation              â”‚
        â”‚ _validate_plan()             â”‚
        â”‚ Check tool_type values       â”‚
        â”‚ Apply defaults if invalid    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Stage Executor               â”‚
        â”‚ _execute_execute()           â”‚
        â”‚ 1. Extract tool_type from    â”‚
        â”‚    Plan                      â”‚
        â”‚ 2. Create async tasks        â”‚
        â”‚ 3. asyncio.gather()          â”‚
        â”‚ 4. Return results            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Results Composition          â”‚
        â”‚ Combine primary + metric     â”‚
        â”‚ results                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Return to User               â”‚
        â”‚ Formatted response           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Plan Schema Evolution

### Current (Before)
```
Plan {
  intent: Intent
  mode: PlanMode
  primary: PrimarySpec {
    keywords: List[str]
    filters: Dict
    limit: int
    âŒ NO tool_type
  }
  metric: MetricSpec {
    metric_name: str
    agg: str
    time_range: TimeRangeSpec
    scope: str
    âŒ NO tool_type
  }
  ...
}
```

### Target (After)
```
Plan {
  intent: Intent
  mode: PlanMode
  primary: PrimarySpec {
    keywords: List[str]
    filters: Dict
    limit: int
    tool_type: str â† NEW (default: "ci_lookup")
  }
  metric: MetricSpec {
    metric_name: str
    agg: str
    time_range: TimeRangeSpec
    scope: str
    tool_type: str â† NEW (default: "metric_query")
  }
  ...
}
```

---

## 7. Prompt Enhancement

### Current Prompt Structure
```
System:
"You are a CI/OPS Query Planner"

Context:
- User Query
- Mapping Assets (keywords only)

Task:
"Generate a Plan with intent and parameters"

âŒ Missing:
- Available Tools Info
- Tool Input Schemas
- Database Catalog
- Tool Selection Instructions
```

### Enhanced Prompt Structure
```
System:
"You are a CI/OPS Query Planner that selects tools"

Context:
- User Query
- Mapping Assets
- âœ… Available Tools with descriptions
- âœ… Tool Input Schemas
- âœ… Database Catalog (tables/columns)

Task:
"Generate a Plan with:
 1. intent and parameters
 2. âœ… tool_type selections (MUST be from available tools)
 3. âœ… Filters based on actual database columns

Example:
{
  'primary': {
    'keywords': [...],
    'filters': {...},
    'tool_type': 'ci_lookup'  â† Selected from available tools
  }
}"

âœ… Added:
- Tool Selection Instructions
- Catalog-based Filter Definition
- Validation Rules
```

---

## 8. Implementation Phases Summary

```
Phase 1: Plan Schema      [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] 1 day
  - Add tool_type field to all Specs

Phase 2: Tool Registry    [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 1 day
  - Add input_schema, get_all_tools_info()

Phase 3: Catalog Loading  [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 1 day
  - load_catalog_for_source()

Phase 4: Planner Prompt   [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 1-2 days
  - Include all context info
  - Tool selection instructions

Phase 5: Parallel Exec.   [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 1 day
  - asyncio.gather() implementation

Phase 6: Testing          [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 2-3 days
  - Unit + Integration + E2E tests

Phase 7: Documentation    [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 1 day

Phase 8: Optimization     [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] Ongoing
```

Total estimated: **8-10 days** for complete implementation

---

## 9. Quick Reference: Key Files to Modify

| Phase | File | Changes |
|-------|------|---------|
| 1 | `plan_schema.py` | Add `tool_type` field |
| 2 | `base.py` | Add `input_schema` field |
| 2 | `registry.py` | Add info retrieval methods |
| 3 | `loader.py` | Add catalog loader function |
| 4 | `planner_llm.py` | Enhance prompt builder |
| 5 | `stage_executor.py` | Implement parallel execution |
| 6 | `tests/` | Add comprehensive tests |

